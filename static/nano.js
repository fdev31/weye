
mimes={"audio":{display:function(item){$('<audio src="/d'+item.path+'" controls><span>Audio preview not supported on your browser</span></audio>').appendTo($('#contents').html(get_view('file',item)));ui.set_context('item');},name:"audio"},"default":{display:function(item){Nano.set_content(item);},name:"default"},"folder":{display:function(item){$.get('/c'+item.get_ref()).success(function(c){item.children=uncompress_resources(c.children);Nano.set_content(item);});},name:"folder"},"image":{display:function(item){Nano.set_content(item);$('<img class="img-responsive" src="'+item.get_raw_ref()+'" />').appendTo($('#contents'));},name:"image"},"text-x":{display:function(item){console.log('DISP text-x');console.log(item);console.log(item.get_ref());var _map={'text-css':'css','text-html':'html','application-xhtml+xml':'html','application-javascript':'javascript','text-x-sh':'shell'}
$.ajax('/d'+item.get_ref(),{dataType:'text'}).done(function(d){console.log('done');var lang=_map[item.mime];if(!!!lang)
lang=item.mime.split('-')[2];var pre=$('<pre><code data-language="'+lang+'"></code></pre>');pre.find('code').text(d);pre.appendTo($('#contents'));if(item.size>15000){$.pnotify({type:'warning',title:'File is too big',text:'Syntax coloring disabled.'});}else{Rainbow.color();}}).fail(function(e){$.pnotify({type:'error',title:'Loading item',text:e});});console.log('set_content',item);Nano.set_content(item);},name:"text-x",stylesheet:true,dependencies:["myobj.js","rainbow.js"]},"text":{display:function(item){console.log('display text',item);Nano.set_content(item);$('<div class="row-fluid"><small>Fullscreen: <i>Alt+F</i>, Toggle preview: <i>Alt+P</i></small></div><div class="row-fluid" id="epiceditor"></div> <div class="pull-right btn-group"></div>').appendTo($('#contents'));$('<button class="btn btn-success btn-large" onclick="editor_save()">Save changes</button>').appendTo($('#download_link').parent()).hide().fadeIn();var ajax_call=new $.ajax({url:'/d'+item.get_ref(),dataType:'text'}).fail(function(e){$.pnotify({type:'error',text:''+e});})
setTimeout(function(){Nano._editor=new EpicEditor(epic_opts);Nano._editor.load(function(){ajax_call.done(function(d){Nano._editor.importFile(item.get_ref(),d);})})},100);},name:"text",dependencies:['epicobj.js']},"video":{display:function(item){$('<video controls src="/d'+item.path+'">Alt descr</video>').appendTo($('#contents').html(get_view('file',item)));ui.set_context('item');},name:"video"}}
mimes["application-javascript"]=mimes["text-x"];mimes["text-css"]=mimes["text-x"];"use strict";function inherits(new_cls,base_cls){new_cls.prototype=Object.create(base_cls.prototype);new_cls.prototype.constructor=new_cls;};String.prototype.endswith=function(suffix){return this.indexOf(suffix,this.length-suffix.length)!==-1;};String.prototype.startswith=function(prefix){return!!this.match(RegExp('^'+prefix));};function copy(obj,blacklist){var o={}
if(blacklist){for(var key in obj){var blisted=false;for(var bl in blacklist){if(blacklist[bl]===key)
blisted=true;}
if(!blisted)
o[key]=obj[key];}}else{for(var key in obj){o[key]=obj[key];}}
return o;};function instanceOf(object,constructor){while(object!=null){if(object==constructor.prototype)
return true;object=Object.getPrototypeOf(object);}
return false;}"use strict";$(function(){$('#addsearch_form').submit(function(){return false});$('#file').bootstrapFileInput();var up=new uploader($('#file').get(0),{url:'/upload',extra_data_func:function(data){return{'prefix':Nano.doc_ref}},progress:function(ev){$('#file_caption').text('Uploaded '+Math.ceil((ev.loaded/ev.total)*100)+'%');},error:function(ev){$.pnotify({title:"Can't upload",text:''+ev,type:'error'})},success:function(data){$('#file_caption').text('Add file...');var data=JSON.parse(data);if(data.error){$.pnotify({title:'Unable to upload some files',text:data.error,type:'error'});var child=[];}else{var child=uncompress_resources(data.children);for(var i=0;i<child.length;i++){var c=child[i];if(!!!c.title)c.title=c.link;if(!!!c.cont)c.cont=Nano.doc_ref;Nano.content.insert(ResourceFactory(c));}}
setTimeout(function(){if(child.length===0){$.pnotify({type:'warning',title:"Upload",text:"No file were uploaded"});}else{for(var i=0;i<child.length;i++){$.pnotify({type:"success",title:"Uploaded",text:child[i].link,delay:1500});}}
$('div.maincontainer .file-input-name').html('');},5);}});Nano._uploader=up;$('#file').attr('title','Upload some file');setTimeout(function(){window.addEventListener("popstate",function(e){if(!!e.state)Nano.load_link(e.state.view,{disable_history:true})
return false;});},1000);Mousetrap.bind('tab',function(e){if(ui.selected_item===-1){return ui.select_idx(null,0);}});Mousetrap.bind('down',function(e){e.cancelBubble=true;return ui.select_next();});Mousetrap.bind('up',function(e){e.cancelBubble=true;return ui.select_prev();});Mousetrap.bind('enter',function(e){var items=ui.get_items();$(items[ui.selected_item]).find('.item_touch:first').trigger('tap');return false;});Mousetrap.bind('backspace',function(e){$('#backlink').click();return false;});Mousetrap.bind('ins',function(e){$('#file').trigger('click');return false;});Mousetrap.bind('del',function(e){$.pnotify({text:'Could show a delete popup... ?'});return false;});Mousetrap.bind('ctrl+space',function(e){var inp=$('#addsearch_form input[name=text]');if(inp.is(':focus')){filter_result('');}else{inp.focus();}
return false;});Mousetrap.bind('esc',function(e){return ui.select_idx(ui.selected_item,null);});Mousetrap.bind('home',function(e){return ui.select_idx(ui.selected_item,0);});Mousetrap.bind('end',function(e){return ui.select_idx(ui.selected_item,-1);});Nano.load_link(document.location.href.split(/\?view=/)[1]||'/',{disable_history:true});});"use strict";var Templates={};function TemplateFactory(item){var t=MimeManager.get_template(item.mime);var i=new t(item);return i;}
function PageTemplate(data,name){if(!!!name)
name='file';this.data=data;this.name='view_'+name;}
PageTemplate.prototype.from=function(resource){return ich[this.name](resource||this.data);};PageTemplate.prototype.draw=function(resource){$('#contents').html(this.from(resource));};PageTemplate.prototype.clear=function(){$('#contents').html('');};function ItemList(data,item_template){PageTemplate.call(this,data);this.selected=-1;this.item_template='view_'+(item_template||UI.item_template);this.data.item_template=this._item_templater;this._c=data.children||[];var _r={}
this._index=_r;for(var i=0;i<this._c.length;i++){this._c[i]._parent=this;_r[this._c[i].link]=i;}}
inherits(ItemList,PageTemplate);Templates['folder']=ItemList;ItemList.prototype.get_dom=function(link){return $('.items .item[data-link="'+link+'"]');};ItemList.prototype.find_by_link=function(link){return this._c[this._index[link]];};ItemList.prototype.refresh_by_link=function(link,metadata){var item=this._c[this._index[link]];$.extend(item,metadata);var e=this.get_dom(item.link).html(ich[this.item_template](item).children().html());this.setup_links(e);};ItemList.prototype.select=function(index){self.selected+=index;};ItemList.prototype.insert=function(resource){var d=ich[this.item_template](resource).children();this._index[resource.link]=d;this._c.push(d);$('.items').isotope('insert',d);};ItemList.prototype.remove=function(resource){var e=this.get_dom(resource.link);e.fadeOut(function(){e.remove();$('.items').isotope('reLayout');});};ItemList.prototype.sort_by=function(dom_elt,criteria){UI.fix_nav(dom_elt);$('.items').isotope({sortBy:criteria});};ItemList.prototype._item_templater=function(data){return ich[this._parent.item_template](this).html();};ItemList.prototype.draw=function(){PageTemplate.prototype.draw.call(this);$('.items').isotope({itemSelector:'.item',layoutMode:'fitRows',sortBy:'type',animationEngine:'css',transformsEnabled:'false',getSortData:{title:function(e){return e.data('title');},type:function(e){var m=e.data('mime');if(m==='folder'){return'!!!!!!!'+e.data('title').toLocaleLowerCase();}
return e.data('mime')+'!'+e.data('title').toLocaleLowerCase();}}});if(this._c.length===0)
$.pnotify({type:'info',title:'Attention',text:'No item in this folder.',delay:1000});this.setup_links($('.items'));};ItemList.prototype.setup_links=function(jqelt){jqelt.find('.item_touch').hammer().bind({tap:UI.execute_item_handler});};"use strict";function ResourceFactory(item){if(item.size!==undefined){return new Item(item);}else{return new Resource(item);}}
function Resource(dict){$.extend(this,dict);if(!!!dict.link){}else{if(!!!this.cont){if(!!this.link.match(RegExp('/'))){var c=this.link.split(RegExp('(.*)/(.*)'));this.cont=c[1];this.link=c[2];}else{this.cont=Nano.doc_ref;}}}
if(this.cont!=undefined&&this.cont.substr(-1)!=='/')
this.cont+='/';if(this.mime!=='folder')
this.is_data=true;if(!!!this.editables)
this.editables='title mime descr';this.type='resource';};Resource.prototype.searchable='title';Resource.prototype.hr_size=function(){console.log('hr_size',this);return UI.hr_size(this.size);};Resource.prototype.getItem=function(callback,opts){var opts=opts||{};$.get(this.get_obj_ref()).success(function(d){if(d.error){$.pnotify({title:'Error displaying "'+d.link+'" content',text:d.message});}else{callback(ResourceFactory(d),opts);}}).error(function(){$.pnotify({title:'Error loading "'+path+'"',text:"Server not responding."});go_ready();});};Resource.prototype.post_view_callback=function(){if(this.mime==='folder'){$('.folder-item').fadeIn(function(){$('.folder-item').removeClass('hidden');});$('.pure-item').fadeOut(function(){$('.pure-item').addClass('hidden');});}else{$('.folder-item').fadeOut(function(){$('.folder-item').addClass('hidden');});$('.pure-item').fadeIn(function(){$('.pure-item').removeClass('hidden');});$('#main_header .big_icon').addClass('faded_in');}};Resource.prototype.edit=function(){if(this.link.startswith('js:')){UI.edit_item(this);}else{this.getItem(function(item){UI.edit_item(item);});}};Resource.prototype.del=function(){var src_link=this.link;$.ajax(this.get_obj_ref(),{type:'DELETE'}).done(function(d){if(d.error){$.pnotify({type:'error',title:"Can't remove "+src_link,text:d.error});}else{Nano.content.remove({link:src_link});}});};Resource.prototype.view=function(){$('#contents').addClass('slided_left');Nano.load_resource(this);};Resource.prototype.save=function(){};Resource.prototype.get_ref=function(){if(!!!this.cont||!!!this.link)
return'/';return this.cont+this.link;};Resource.prototype.get_raw_ref=function(){return'/d'+this.get_ref();};Resource.prototype.get_obj_ref=function(){return'/o'+this.get_ref();};Resource.prototype.get_child_ref=function(){return'/c'+this.get_ref();};function Item(dict){Resource.call(this,dict);if(!!!this.title)
this.title=this.link;if(!!!this.descr)
this.descr='No description';this.type='item';};inherits(Item,Resource);"use strict";var UI={item_template:'list_item_big',filter_items:function(filter){var filter=filter;var forced_searchables=null;if(typeof(filter)!=='string'){filter=$('#addsearch_form input[name=text]').val();}
var meta_re=filter.match(RegExp('^([a-z][a-z09]*): *(.*?) *$'));if(!!meta_re){var meta=meta_re[1];if(meta==='type')
meta='mime';forced_searchables=[meta];filter=meta_re[2];}
var re=new RegExp(filter.toLocaleLowerCase());var match_func=function(elt){var searchables=forced_searchables||elt.data('searchable').split(/ +/);for(var i=0;i<searchables.length;i++){if(elt.data(searchables[i]).toLocaleLowerCase().match(re))
return true;}
return false;};$('.item').each(function(i,e){var e=$(e);if(match_func(e)){e.addClass('filtered');}else{e.removeClass('filtered');}});$('.items').isotope({filter:'.filtered'});},fix_nav:function(link){$('div.navbar ul.nav li').removeClass('active');$(link).parent().addClass('active');},hr_size:function(size){if(size===undefined)return'N/A';var units=['','k','M','G'];var i=0;while(size>=1024){size/=1024.0;++i;}
return size.toFixed(1)+' '+units[i]+'B';},render_dom:function(resource,opts){var resource=copy(resource);var opts=opts||{};console.log('rendering',resource);var hdr=$('#main_header');resource.permalink=window.location.href;hdr.replaceWith(ich.header(resource));if(Nano.current.get_ref()==='/'){$('#backlink').addClass('disabled');}else{$('#backlink').removeClass('disabled');}
setTimeout(function(){$('#contents').hide().removeClass('slided_right slided_left');MimeManager.load_dependencies(resource.mime,{callback:function(found){found.display(resource);}})
var name=resource.mime;var buttons=$('#addsearch_form');buttons.find('button').removeClass('hidden');resource.post_view_callback.call(resource);if(!!!opts.disable_history)
history.pushState({'view':''+Nano.doc_ref},"Staring at "+Nano.doc_ref,'/#?view='+Nano.doc_ref);var c=$('#contents');c.fadeIn();},100);},edit_item:function(data){UI._edited=data;var qp=$('#question_popup');if(qp.length!=0){if(qp.css('display')==='none'){qp.remove();}else{return;}}
var edited=[];if(data.editables===""){for(var k in data)
edited.push({name:k,type:'text'});}else{var editables=data.editables.split(/ +/);for(var k in editables){edited.push({name:editables[k],type:'text'})};}
var pop=ich.question({'item':data,'title':data.title||data.link,'mime':data.mime,'footnote':'Changes may be effective after a refresh','edit':edited,'buttons':[{'name':'Save','onclick':'UI.save_item($("#question_popup .editable").data("link"));false;','class':'btn-success'},{'name':'Delete','onclick':'UI.remove_item($("#question_popup .editable").data("link"));false;','class':'btn-warning'}]});pop.modal();var edited=$('#question_popup .editable');setTimeout(function(){pop.find('.editable-property').each(function(i,o){var o=$(o);var d=copy(o.data());d.content=data[d.name];o.append(ich['input_'+d.type](d));});},200);},remove_item:function(){UI._edited.del();UI.close_modal();},save_item:function(){var o=$('#question_popup .editable');var item=UI._edited;var metadata={};var metadata_list=[];var full_item={};o.find('.editable-property').each(function(x,property){var property=$(property);var inp=property.find('input');var orig=inp.data('orig-value');var val=inp.val();var name=property.data('name');if(val!==orig){metadata[name]=inp.val();metadata_list.push(name);}});if(metadata_list.length==0){$.pnotify({text:'No change'});}else{$.ajax(item.get_obj_ref(),{dataType:'json',data:{meta:JSON.stringify(metadata)},type:'PUT'}).done(function(e){Nano.content.refresh_by_link(UI._edited.link,metadata);$.pnotify({type:"success",text:"Saved"});UI.close_modal();}).fail(function(e){$.pnotify({type:"error",text:''+e});});}},close_modal:function(){$('#question_popup').modal('hide',function(){console.log('hidden !!');});},find_item_from_child:function(dom){var st=$(dom);while(!!!st.hasClass('item')){if(st.hasClass('items')){st=null;break;}else{st=st.parent();}}
return Nano.content.find_by_link(st.data('link'));},execute_item_handler:function(){UI.find_item_from_child(this).view();}};"use strict";function uncompress_resources(keys_values_array){var keys=keys_values_array.c;var list_of_values=keys_values_array.r;var ret=[];for(var i=0;i<list_of_values.length;i++){var values=list_of_values[i];var item={};for(var pid=0;pid<keys.length;pid++){item[keys[pid]]=values[pid];}
ret.push(ResourceFactory(item));}
return ret;};var Nano={doc_ref:'/'};Nano.current=new Resource({link:'',mime:'folder',cont:''});Nano.get=function(link){};Nano._go_busy=function(){};Nano._go_ready=function(){};Nano._unload_plugins=function(){$('audio').each(function(){this.pause();this.src="";});};if(!!mimes){Nano.mimes=mimes;};Nano.set_content=function(item,opts){this.content=TemplateFactory(item);this.content.draw();};Nano.reload=function(){return this.load_resource(this.current);};Nano.load_link=function(link,opts){var r=new Resource({link:link});Nano.doc_ref=r.cont;this.load_resource(r,opts);};Nano.load_resource=function(resource,opts){if(instanceOf(resource,Item)){Nano._load_resource_cb(resource,opts);}else{resource.getItem(Nano._load_resource_cb,opts);}};Nano._load_resource_cb=function(resource,opts){var opts=opts||{};Nano.doc_ref=resource.get_ref();Nano.current=ResourceFactory(resource);UI.render_dom(resource,opts);};Nano.level_up=function(opts){var opts=opts||{};var bref=Nano.doc_ref.match(RegExp('(.*)/[^/]+$'));if(!!bref){bref=bref[1]||'/';$('#contents').addClass('slided_right');Nano.load_link(bref,{'history':!!!opts.disable_history});}};var MimeManager={loaded:{}};MimeManager.mimes={};MimeManager.find_choices=function(mime){var choices=[mime];var subchoices=mime.split('-');for(var n=subchoices.length-1;n>=1;n--){choices.push(subchoices.slice(0,n).join('-'));}
choices.push('default');return choices;}
MimeManager.get_template=function(mime){var choices=MimeManager.find_choices(mime);for(var i=0;i<choices.length;i++){var choice=choices[i];for(var k in Templates){if(k===choice)
return Templates[k];}}
return PageTemplate};MimeManager.load_dependencies=function(mime,opts){var opts=opts||{};var skip_loading=false;if(MimeManager.loaded[mime])
skip_loading=true;MimeManager.loaded[mime]=true;var found=false;var choices=MimeManager.find_choices(mime);for(var n=0;(!!!found)&&n<choices.length;n++){try{found=Nano.mimes[choices[n]];}catch(err){found=false;}
if(found){if(!!!skip_loading){var dependencies=[];var prefix='/static/mime/js/'+found.name+'/';if(!!found.stylesheet)
dependencies.push(prefix+'style.css');if(found.dependencies){found.dependencies.forEach(function(x){if(x.match(/^[/]/)){dependencies.push(x)}else{dependencies.push(prefix+x);}})}
if(dependencies.length!==0){var counter=0;for(var dep in dependencies){toast(dependencies[dep],function(){if(++counter===dependencies.length){if(opts.callback){setTimeout(function(){opts.callback(found);},100);}}});}}else{if(opts.callback)opts.callback(found);}}else{if(opts.callback)opts.callback(found);}
break;}}
if(!!!found){$.pnotify({'type':'error','title':'Type association','text':'failed loading one of: '+choices});}}